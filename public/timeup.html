<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time Up!!</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #4a148c 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Arial', sans-serif;
            cursor: pointer;
            user-select: none;
            overflow: hidden;
        }

        .timeup-container {
            text-align: center;
            animation: pulse 2s ease-in-out infinite;
        }

        .timeup-text {
            font-size: 8rem;
            font-weight: bold;
            color: white;
            text-shadow: 0 0 30px rgba(255, 255, 255, 0.8);
            margin-bottom: 2rem;
            letter-spacing: 0.1em;
        }

        .timeup-subtitle {
            font-size: 2rem;
            color: rgba(255, 255, 255, 0.9);
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.6);
            margin-bottom: 1rem;
        }

        .timeup-instruction {
            font-size: 1.2rem;
            color: rgba(255, 255, 255, 0.7);
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.4);
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
            100% {
                transform: scale(1);
            }
        }

        /* ホバー効果 */
        body:hover .timeup-text {
            text-shadow: 0 0 40px rgba(255, 255, 255, 1);
        }

        body:hover .timeup-subtitle {
            text-shadow: 0 0 30px rgba(255, 255, 255, 0.8);
        }

        body:hover .timeup-instruction {
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.6);
        }
    </style>
</head>
<body onclick="console.log('Body clicked!'); closeWindow()">
    <div class="timeup-container">
        <div class="timeup-text">Time Up!!</div>
        <div class="timeup-subtitle">The time has come.</div>
        <div class="timeup-instruction">Click or press the Esc key to close</div>
    </div>

    <script>
        // 重複実行を防ぐフラグ
        let isClosing = false;

        // Escキーでウィンドウを閉じる
        document.addEventListener('keydown', function(event) {
            console.log('Key pressed:', event.key);
            if (event.key === 'Escape') {
                console.log('Escape key detected!');
                closeWindow();
            }
        });

               // ウィンドウを非表示にする関数
               function closeWindow() {
                   if (isClosing) {
                       console.log('Already closing, ignoring duplicate call');
                       return;
                   }
                   isClosing = true;

                   console.log('=== closeWindow function called ===');
                   console.log('closeWindow called - hiding window');

                   // メインウィンドウにメッセージを送信
                   try {
                       console.log('Sending message to main window');

                       // localStorage経由でメッセージ送信
                       localStorage.setItem('closeTimeUpWindow', Date.now().toString());
                       console.log('Set localStorage flag');

                       // window.opener経由でメッセージ送信（フォールバック）
                       if (window.opener) {
                           console.log('Using window.opener');
                           window.opener.postMessage({ action: 'closeTimeUpWindow' }, '*');
                           console.log('Message sent via window.opener');
                       }

                   } catch (error) {
                       console.error('Failed to send message to main window:', error);
                   }

                   // フラグをリセット（確実に次回も動作するように）
                   setTimeout(() => {
                       isClosing = false;
                       console.log('isClosing flag reset after timeout');
                   }, 100);
               }

        // ページ読み込み完了時の処理
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Time Up window loaded');

            // フラグをリセット
            isClosing = false;

            // Tauri APIの初期化を待つ
            if (window.__TAURI__) {
                console.log('Tauri API already available');
            } else {
                console.log('Waiting for Tauri API...');
                // Tauri APIが利用可能になるまで待機
                const checkTauri = setInterval(() => {
                    if (window.__TAURI__) {
                        console.log('Tauri API now available');
                        clearInterval(checkTauri);
                    }
                }, 50); // より頻繁にチェック

                // 2秒後にタイムアウト
                setTimeout(() => {
                    clearInterval(checkTauri);
                    if (!window.__TAURI__) {
                        console.error('Tauri API not available after timeout');
                    }
                }, 2000); // タイムアウトを短縮
            }
        });
    </script>
</body>
</html>
